[delayed_gcode DELAYED_IDLE_LIGHTS]
initial_duration: 0
gcode:
  {action_respond_info("DELAYED GCODE: Set lights to idle preset")}
  LIGHTS PRESET=IDLE

[delayed_gcode DELAYED_VOC_OFF]
initial_duration: 0
gcode:
  {action_respond_info("DELAYED GCODE: VOC fan shutdown...")}
    VOC_FAN FSPEED=0

[delayed_gcode KLIPPER_STARTUP]
initial_duration: 2
gcode:
  {action_respond_info("DELAYED GCODE: Klipper Startup...")}
  SET_PIN PIN=Buttons VALUE=1
  LIGHTS PRESET=IDLE

[delayed_gcode DELAYED_MCU_OFF]
initial_duration: 0
gcode:
  {% if printer.idle_timeout.state == "Idle" %}
    {action_respond_info("DELAYED GCODE: Power off MCU")}
    POWER_OFF_MCU
  {% else %}
    {action_respond_info("DELAYED GCODE: Not turning off MCU! The printer is not idle! CURRENT STATE: %s " % (printer.idle_timeout.state))}
  {% endif %}

[delayed_gcode FILAMENT_BOX_CONTROL_LOOP]
initial_duration: 5
gcode:
  {% set sensor = printer["htu21d filament"] %}
  {% set filament_box = printer["heater_generic filament_box"] %}
  {action_respond_info("DELAYED GCODE: Running filament box control loop...")}
  {% if sensor.humidity > 15 %}
    {% if filament_box.target > 0 %}
      {action_respond_info("FILAMENT_BOX_LOOP: No action taken SET TEMP: %.0f HUMIDITY: %.2f" % (filament_box.target, sensor.humidity))}
    {% elif filament_box.target == 0 %}
      FILAMENT_BOX T=85
    {% endif %}
  {% elif sensor.humidity < 15 and filament_box.target == 0 %}
    {action_respond_info("FILAMENT_BOX_LOOP: Humidity is below threshold and heater is off.  HUMIDITY: %.2f" % (sensor.humidity))}
    UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=900
  {% else %}
    {action_respond_info("FILAMENT_BOX_LOOP: Turning filament box heater OFF. HUMIDITY: %.2f%%" % (sensor.humidity))}
    FILAMENT_BOX T=0
  {% endif %}
  UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=1800