#####################################################################
#   PRINT START END PAUSE RESUME
#####################################################################
   
[gcode_macro PRINT_START]
gcode:
    {action_respond_info("Running PRINT START...")}
    STOP_DELAYED_GCODE
    RESET_SPEEDS_FEEDS
    {% set bedtemp = params.BED|int %}
    {% set hotendtemp = params.EXTRUDER|int %}
    {% set chambertemp = params.CHAMBER|default(0)|int %}
    LIGHTS PRESET=PRINTING                                                       ; Turn on the lights
    SET_BED_CONT TEMP={bedtemp}                                                  ; Start heating the bed
    FILAMENT_DETECT FILAMENT={params.FILAMENT}
    CG28                                                                         ; Conditional G28
    G21                                                                          ; set units to mm
    G90                                                                          ; use absolute coordinates
    M83                                                                          ; relative extruder positioning
    G92 E0.0                                                                     ; reset extruder distance position
    M220 S100                                                                    ; reset speed multiplier
    VOC_FAN FSPEED=100                                                           ; Set fan to 100% to help chamber temps
    LIGHTS PRESET=HEATING                                                        ; Set lights to heating
    PARKBED                                                                      ; Move extruder to the center of the bed
    SET_BED_WAIT TEMP={bedtemp}                                                  ; wait for bed temp
    SET_CHAMBER_MINIMUM TEMP={chambertemp}                                       ; wait for chamber temp
    G32
    LIGHTS PRESET=HEATING                                                        ; Set lights to heating
    SET_EXTRUDER_WAIT TEMP={hotendtemp}                                          ; wait for hotend temp
    LIGHTS PRESET=PRINTING                                                       ; Set printing lights
    PURGE_LINE
    G28 Z                                                                        ; final z homing with hot nozzle
    SFS_ENABLE
    VOC_FAN                                                                      ; Set fan to default speed

    
[gcode_macro PURGE_LINE]
description: Extrude a purge line at 0,0,.35. Perams: NONE
gcode:
   {action_respond_info("Running Purge line...")}
   G90                                                                          ; absolute positioning
   M83                                                                          ; relative extruder positioning
   G1 X0 Y0 F3000                                                               ; move to purge strip start position
   G1 Z0.35 F3000                                                               ; drop to 0.35 print height
   G1 E6.0 F140                                                                 ; Spew a small puddle - cleans gunk
   G1 X60.0 E6.0 F800.0                                                         ; intro line 1
   G1 X120.0 E10.5 F1000.0                                                      ; intro line 2 - a little fatter than line 1
   G1 E-.75 Z1                                                                  ; Retract some after purge line
   G92 E0.0                                                                     ; reset extruder distance position    

[gcode_macro PRINT_END]
gcode:
    {action_respond_info("Running PRINT END...")}
    M400                                                                        ; wait for buffer to clear
    G92 E0                                                                      ; zero the extruder
    G1 E-2.0 F3600                                                              ; retract filament
    G91                                                                         ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000                                                 ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=2
    M107                                                                        ; turn off fan
    G1 Z40 F3000                                                                ; move nozzle up 40mm
    G90                                                                         ; absolute positioning
    G0  X125 Y250 F3600                                                         ; park nozzle at rear
    BED_MESH_CLEAR
    SFS_DISABLE
    VOC_FAN FSPEED=100                                                          ; Make sure VOC fan remains on
    LIGHTS PRESET=PRINT_HOT                                                     ; Set Print Complete Lights
    UPDATE_DELAYED_GCODE ID=PRINT_COOLDOWN_LOOP DURATION=300                    ; Start print cooldown loop
    UPDATE_DELAYED_GCODE ID=DELAYED_DISABLE_STEPPERS DURATION=3600              ; Disable steppers after 1hr of print completion
    UPDATE_DELAYED_GCODE ID=DELAYED_IDLE_LIGHTS DURATION=3600                   ; Set Idle lights after 1hr of print completion
    UPDATE_DELAYED_GCODE ID=DELAYED_VOC_OFF DURATION=300                        ; Turn off VOC fan after bed temp is below 50 C

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    {action_respond_info("Running PRINT CANCEL...")}
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    G91                                                                         ; relative positioning
    G1 Z40 F3000                                                                ; move nozzle up 40mm
    G90                                                                         ; absolute positioning
    G0  X125 Y250 F3600                                                         ; park nozzle at rear
    SFS_DISABLE
    BED_MESH_CLEAR
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT


[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
variable_extrude: 1.0                                                           ; Change this if you need more or less extrusion
gcode:
    {action_respond_info("Running PRINT PAUSE...")}
    ##### read E from pause macro #####
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    ##### set park positon for x and y #####
    # default is your max posion from your printer.cfg
    {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
    {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% if act_z < (max_z - 2.0) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    ##### end of definitions #####
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
  
[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
    {action_respond_info("Running PRINT RESUME...")}
    ##### read E from pause macro #####
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    ##### end of definitions #####
    G91
    G1 E{E} F2100
    RESTORE_GCODE_STATE NAME=PAUSE_state
    BASE_RESUME

#####################################################################
#       FILAMENT
#####################################################################

[gcode_macro FILAMENT_DETECT]
description: Detect filament types handler PERAMS: FILAMENT
gcode:
    {% set filament = params.FILAMENT|default(PLA)|string %}
    {action_respond_info("Filament Type: %s detected." % (filament))}
    {% if 'ABS' in filament or 'ABS+' in filament
    or 'ASA' in filament or 'PC' in filament or 'PCCF' in filament %}
        SET_EXTRUDER_CONT TEMP=180
        SET_PADVANCE V=0.050
        FILAMENT_BOX T=85
        UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=1
        EXAUST_FAN FSPEED=0
    {% elif 'PLA' in filament or 'PETG' in filament or 'HTPLA' in filament
    or 'TPU' in filament %}
        #SET_PRESSURE_ADVANCE ADVANCE=0.055
        SET_EXTRUDER_CONT TEMP=160
        FILAMENT_BOX T=75
        UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=1
        EXAUST_FAN
    {% else %}
        {action_respond_info("No filament type given. Setting dryer to LOW temp.")}
        #SET_PRESSURE_ADVANCE ADVANCE=0.055
        SET_EXTRUDER_CONT TEMP=140
        FILAMENT_BOX T=75
        UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=1
        EXAUST_FAN
    {% endif %}

[gcode_macro FILAMENT_RUNOUT]
gcode:
    {action_respond_info("Filament runout/jam detected...")}
    SAVE_GCODE_STATE NAME=FILAMENT_RUNOUT
    G91                                                                         ; relative
    G0 Z10 F900                                                                 ; move up 10mm
    G90                                                                         ; absolute
    G0 X220.00 Y0 F5000                                                         ; move the extruder to runout position
    #UNLOAD_FILAMENT
    SFS_DISABLE
    G90                                                                         ; absolute
    RESTORE_GCODE_STATE NAME=FILAMENT_RUNOUT

[gcode_macro SFS_DISABLE]
description: Disable smart filament sensor PERAMS: NONE
gcode:
    {action_respond_info("DISABLING the Smart Filament Sensor...")}
    G92 E0
    G4 P0
    SET_FILAMENT_SENSOR SENSOR=SFS_T0 ENABLE=0

[gcode_macro SFS_ENABLE]
description: Enable smart filament sensor PERAMS: NONE
gcode:
    {action_respond_info("ENABLING the Smart Filament Sensor...")}
    G92 E0
    G4 P0
    SET_FILAMENT_SENSOR SENSOR=SFS_T0 ENABLE=1

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {action_respond_info("Unloading filament...")}
    SAVE_GCODE_STATE NAME=UNLOADFILAMENT
    M83                                                                         ; set extruder to relative
    G1 E10 F600                                                                 ; extrude a little to soften tip 
    G1 E-50 F1800                                                               ; retract filament completely
    G1 E-50 F1800                                                               ; retract filament completely
    SFS_DISABLE
    RESTORE_GCODE_STATE NAME=UNLOADFILAMENT

[gcode_macro LOAD_FILAMENT]
gcode:
    {action_respond_info("Loading filament...")}
    SAVE_GCODE_STATE NAME=LOADFILAMENT
    M83                                                                         ; set extruder to relative
    G1 E45 F600
    G1 E45 F600
    G1 E45 F600
    G1 E45 F600
    RESTORE_GCODE_STATE NAME=LOADFILAMENT
   
[gcode_macro HOT_UNLOAD]
gcode:
    {action_respond_info("Hot unload called...")}
    {% set t = params.T|default(240)|int %}
    M104 S{t}
    PARKFRONT
    M109 S{t}
    UNLOAD_FILAMENT
    
[gcode_macro HOT_LOAD]
gcode:
    {action_respond_info("Hot load called...")}
    {% set t = params.T|default(240)|int %}
    M104 S{t}
    PARKFRONT
    M109 S{t}
    LOAD_FILAMENT

[gcode_macro FILAMENT_BOX]
description: Set Filament Box temperature. Perams: T
gcode:
    {% set temp = params.T|default(80)|float %}
    {action_respond_info("Setting filament dryer to %sC" % (temp))}
    SET_HEATER_TEMPERATURE HEATER=filament_box TARGET={temp}

[gcode_macro DISABLE_FILAMENT_BOX_CONTROL_LOOP]
description: Disable filament box control loop. Perams: NONE
gcode:    
    {action_respond_info("Filament box control loop DISABLED...") }
    UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=0

#####################################################################
#   FAN CONTROL MACROS
#####################################################################

[gcode_macro EXAUST_FAN]
description: Set EXAUST fan speed. Perams: FSPEED
gcode:
    {% set fanSpeed = params.FSPEED|default(100)|float / 100 %}
    {action_respond_info("EXAUST fan speed set to %.0f%%" % (fanSpeed * 100))}
    SET_FAN_SPEED FAN=exhaust_fan SPEED={fanSpeed}

[gcode_macro VOC_FAN]
description: Set VOC fan speed. Perams: FSPEED
gcode:
    {% set fanSpeed = params.FSPEED|default(50)|float / 100 %}
    {action_respond_info("VOC fan speed set to %.0f%%" % (fanSpeed * 100))}
    SET_FAN_SPEED FAN=VOC_Fan SPEED={fanSpeed}

#####################################################################
#   CONDITIONAL HOMING
#####################################################################

[gcode_macro XYCG28]
description: Conditionally home XY if has not been homed before Perams: NONE
gcode:
    {% if "xy" not in printer.toolhead.homed_axes %}
        G28 X Y
    {% endif %}

[gcode_macro ZCG28]
description: Conditionally home Z if has not been homed before Perams: NONE
gcode:
    {% if "z" not in printer.toolhead.homed_axes %}
        G28 Z
    {% endif %}

[gcode_macro CG28]
description: Conditionally home XYZ if has not been homed before Perams: NONE
gcode:
    {action_respond_info("Conditional G28 has been called...")}
    {% if "xyz" not in printer.toolhead.homed_axes %}
        {action_respond_info("Doing a full G28 as the printer has not been homed before. CURRENT STATE: %s" % (printer.toolhead.homed_axes))}
        G28                                                                     ; Home All Axes
    {% else %}
        {action_respond_info("Printer already homed. CURRENT STATE: %s" % (printer.toolhead.homed_axes))}
    {% endif %}

#####################################################################
#       PARKING
#####################################################################

[gcode_macro PARKFRONT]
description: Park the extruder front and center. Perams: NONE
gcode:
    {action_respond_info("Parking EXTRUDER to the front...")}
    CG28
    SAVE_GCODE_STATE NAME=PARKFRONT
    G90
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+10} Z{printer.toolhead.axis_maximum.z/2} F19500
    RESTORE_GCODE_STATE NAME=PARKFRONT
    
[gcode_macro PARKFRONTLOW]
description: Park the extruder front and low to the bed. Perams: NONE
gcode:
    {action_respond_info("Parking EXTRUDER to the front low to the bed (Z20)...")}
    CG28
    SAVE_GCODE_STATE NAME=PARKFRONTLOW
    G90
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+10} Z20 F19500
    RESTORE_GCODE_STATE NAME=PARKFRONTLOW
    
[gcode_macro PARKREAR]
description: Park the extruder to the rear. Perams: NONE
gcode:
    {action_respond_info("Parking EXTRUDER to the rear...")}
    CG28
    SAVE_GCODE_STATE NAME=PARKREAR
    G90
    G0 X{printer.toolhead.axis_minimum.x+10} Y{printer.toolhead.axis_maximum.y-10} Z{printer.toolhead.axis_maximum.z-50} F19500
    RESTORE_GCODE_STATE NAME=PARKREAR

[gcode_macro PARKCENTER]
description: Park the extruder in the center of the build volume. Perams: NONE
gcode:
    {action_respond_info("Parking EXTRUDER in the center of the build volume...")}
    CG28
    SAVE_GCODE_STATE NAME=PARKCENTER
    G90
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} Z{printer.toolhead.axis_maximum.z/2} F19500
    RESTORE_GCODE_STATE NAME=PARKCENTER
    
[gcode_macro PARKBED]
description: Park the extruder in the center of the bed Z at 15mm. Perams: NONE
gcode:
    {action_respond_info("Parking EXTRUDER in the center of the bed Z at 15mm...")}
    CG28
    SAVE_GCODE_STATE NAME=PARKBED
    G90
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} Z15 F19500
    RESTORE_GCODE_STATE NAME=PARKBED

#####################################################################
#   MATERIAL PREHEAT
#####################################################################

[gcode_macro PREHEAT_ABS_PC]
description: Preheat ABS/PC
gcode:
    {action_respond_info("PREHEAT: ABS/PC...")}
    CG28
    VOC_FAN FSPEED=100
    LIGHTS PRESET=HEATING
    PARKBED
    M140 S110
    FILAMENT_BOX T=85
    UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=1
    STOP_DELAYED_GCODE

[gcode_macro PREHEAT_PLA]
description: Preheat PLA
gcode:
    {action_respond_info("PREHEAT: PLA...")}
    CG28
    VOC_FAN FSPEED=0
    LIGHTS PRESET=HEATING
    PARKBED
    M140 S60
    FILAMENT_BOX T=80
    UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=1
    STOP_DELAYED_GCODE

[gcode_macro PREHEAT_PETG]
description: Preheat PETG
gcode:
    {action_respond_info("PREHEAT: PETG...")}
    CG28
    VOC_FAN FSPEED=0
    LIGHTS PRESET=HEATING
    PARKBED
    M140 S80
    FILAMENT_BOX T=80
    UPDATE_DELAYED_GCODE ID=FILAMENT_BOX_CONTROL_LOOP DURATION=1
    STOP_DELAYED_GCODE

#####################################################################
#   SET TEMPERATURES
#####################################################################

[gcode_macro SET_BED_CONT]
description: Set bed temperature and continue PERAMS: TEMP
gcode:
    {% set bedtemp = params.TEMP|int %}
    { action_respond_info("Setting BED temp to %.0f C and CONTINUING..." % (bedtemp)) }
    M140 S{bedtemp} 

[gcode_macro SET_BED_WAIT]
description: Set bed temperature and wait till its reached. PERAMS: TEMP
gcode:
    {% set bedtemp = params.TEMP|int %}
    {action_respond_info("Setting BED temp to %.0f C and WAITING..." % (bedtemp))}
    M190 S{bedtemp}          

[gcode_macro SET_CHAMBER_MINIMUM]
description: Detect filament types and run. PERAMS: TEMP
gcode:
    {% set chambertemp = params.TEMP|int %}   
    {action_respond_info("Waiting for CHAMBEER temp reach %.0f C..." % (chambertemp))}
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={chambertemp}

[gcode_macro SET_EXTRUDER_WAIT]
description: Set extruder temperature and wait till its reached. PERAMS: TEMP
gcode:
    {% set hotendtemp = params.TEMP|int %}
    {action_respond_info("Setting EXTRUDER temp to %.0f C and WAITING..." % (hotendtemp))}
    M109 S{hotendtemp}

[gcode_macro SET_EXTRUDER_CONT]
description: Set extruder temperature and continue PERAMS: TEMP
gcode:
    {% set hotendtemp = params.TEMP|int %}
    {action_respond_info("Setting EXTRUDER temp to %.0f C and CONTINUING..." % (hotendtemp))}
    M104 S{hotendtemp}

#####################################################################
#   SENSORS
#####################################################################

[gcode_macro QUERY_SENSORS]
description: Query HTU21D sensor. Perams: NONE
gcode:
    {% set sensor = printer["htu21d filament"] %}
    {action_respond_info(
        "Temperature: %.2f C\n"
        "Humidity: %.2f%%" % (
                sensor.temperature, sensor.humidity))}

#####################################################################
#   MISC
#####################################################################

[gcode_macro G32]
gcode:
    {action_respond_info("Running G32...")}
    LIGHTS PRESET=PRINTING
    BED_MESH_CLEAR
    CG28
    QUAD_GANTRY_LEVEL
    BED_MESH_CALIBRATE
    G28 Z
    PARKBED

[gcode_macro RESET_SPEEDS_FEEDS]
description: Reset printer speeds and feeds to what is defined in the config file PERAMS: NONE
gcode:
    {action_respond_info("WARNING: RESETTING ALL SPEEDS AND FEEDS TO DEFAULT!!! IF YOU ARE TUNING YOU WILL WANT TO SEND OVERRIDES AGAIN!!!")}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} 
    SET_VELOCITY_LIMIT ACCEL={printer.configfile.settings.printer.max_accel}  
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel} 
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={printer.configfile.settings.printer.square_corner_velocity}
    M221 S100                                                                   ; Reset flow rate to 100%

[gcode_macro STOP_DELAYED_GCODE]
description: Stop defined delayed gcode Perams: NONE
gcode:
    {action_respond_info("Stopping all DELAYED GCODE...")}
    UPDATE_DELAYED_GCODE ID=DELAYED_IDLE_LIGHTS DURATION=0
    UPDATE_DELAYED_GCODE ID=DELAYED_VOC_OFF DURATION=0
    UPDATE_DELAYED_GCODE ID=DELAYED_MCU_OFF DURATION=0
    UPDATE_DELAYED_GCODE ID=DELAYED_LIGHTS_OFF DURATION=0
    UPDATE_DELAYED_GCODE ID=PRINT_COOLDOWN_LOOP DURATION=0
    UPDATE_DELAYED_GCODE ID=DELAYED_DISABLE_STEPPERS DURATION=0

[gcode_macro DUMP_WARNINGS]
description: Debug: Print all warning messages from klipper
gcode:
    {% set parameters = ["printer.configfile.warnings:"] %}
    {% for name1 in printer.configfile.warnings %}
        {% set parameters = parameters.append("%s -> %s -> %s\n%s" % (name1.type, name1.section, name1.option, name1.message)) %}
    {% endfor %}
    {action_respond_info(parameters|join("\n"))}

[gcode_macro SET_PADVANCE]
description: Set presure advance to specified value PERAMS: V
gcode:
    {% set value = params.V|default(0)|float %}
    {% if value == 0 %}
        {% set value = printer.configfile.settings.extruder.pressure_advance %}
    {% endif %}
    {action_respond_info("Setting Presure Advance to %.6f..." % (value)) }
    SET_PRESSURE_ADVANCE ADVANCE={value}